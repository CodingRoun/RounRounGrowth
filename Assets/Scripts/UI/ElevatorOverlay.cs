// ElevatorOverlay.cs

using RounRounGrowth.Building;
using RounRounGrowth.Core;
using UnityEngine;
using UnityEngine.EventSystems;
using UnityEngine.UI;
namespace RounRounGrowth.UI
{
    public class ElevatorOverlay : MonoBehaviour, IPointerClickHandler
    {
        [SerializeField] private RectTransform _elevatorPanel;
        [SerializeField] private BuildingNavigator _navigator;
        [SerializeField] private FloorButtonRef[] _floorButtonRefs;

        [System.Serializable]
        public class FloorButtonRef
        {
            public FloorId Floor;
            public Button Button;
        }

        private void Awake()
        {
            gameObject.SetActive(false);
        }

        private void OnEnable()
        {
            if (_floorButtonRefs == null || _floorButtonRefs.Length == 0)
            {
                Debug.LogWarning("[ElevatorOverlay] 未绑定楼层按钮引用");
                return;
            }
            foreach (var refData in _floorButtonRefs)
            {
                if (refData == null || refData.Button == null)
                {
                    Debug.LogWarning("[ElevatorOverlay] 某个 FloorButtonRef 未绑定");
                    continue;
                }

                refData.Button.onClick.RemoveAllListeners(); // 防止重复绑定
                refData.Button.onClick.AddListener(() =>
                {
                    OnFloorButtonClicked(refData.Floor);
                });
                SetHighlight(_navigator.Current, refData); // 因为广播时处于隐藏状态，无法订阅事件，所以主动获取当前位置
            }
        }

        private void SetHighlight(CurrentLocation currentLocation, FloorButtonRef refData)
        {
            bool isCurrentFloor = refData.Floor == currentLocation.Floor;
            refData.Button.image.color = isCurrentFloor ? new Color(1f, 0.95f, 0.6f) : Color.white;
        }

        private void OnFloorButtonClicked(FloorId floor)
        {
            Debug.Log($"点击了楼层按钮：{floor}");
        }

        public void OnPointerClick(PointerEventData eventData) // 如点击在ElevatorPanel外，则关闭ElevatorOverlay
        {
            if (_elevatorPanel == null)
            {
                Debug.LogWarning("[ElevatorOverlay] 未绑定 ElevatorPanel");
                return;
            }
            bool isClickOutsidePanel = !RectTransformUtility.RectangleContainsScreenPoint(
                _elevatorPanel,
                eventData.position
                );
            bool isPanelShown = gameObject.activeSelf;
            if (isPanelShown && isClickOutsidePanel)
                Hide();
        }

        public void Show() // 打开电梯菜单
        {
            gameObject.SetActive(true);
        }

        public void Hide() // 关闭电梯菜单
        {
            gameObject.SetActive(false);
        }
    }
}

